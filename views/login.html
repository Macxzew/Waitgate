<!-- views/login.html -->
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Waitgate – Log In</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="shortcut icon"
        href="https://camo.githubusercontent.com/e856590000d9caed8575a3aec619545e64a56177baaa1d5149c1e52573c1df03/68747470733a2f2f7374617469632e77696b69612e6e6f636f6f6b69652e6e65742f6e69636f732d6e657874626f74732d66616e6d6164652f696d616765732f342f34332f526576657273655f637562652e6769662f7265766973696f6e2f6c61746573742f7363616c652d746f2d77696474682f3336303f63623d3230323430363136303133353232">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
    <script>window._loginKey = '{{LOGIN_SECRET}}'</script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            font-family: 'Inter', sans-serif;
            color: #e4e6ef;
            background: #101025;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .background {
            position: absolute;
            inset: 0;
            z-index: 0;
            overflow: hidden;
        }

        .grid3d {
            position: absolute;
            width: 240%;
            height: 240%;
            top: -70%;
            left: -70%;
            background-image:
                linear-gradient(0deg, #8a5cff22 1px, transparent 1px),
                linear-gradient(90deg, #8a5cff22 1px, transparent 1px);
            background-size: 44px 44px;
            transform: rotateX(70deg) rotateZ(17deg) scale(1.1);
            transform-origin: center;
            animation: grid-move 65s linear infinite;
            opacity: 0.055;
            pointer-events: none;
        }

        @keyframes grid-move {
            0% {
                transform: rotateX(70deg) rotateZ(17deg) scale(1.1) translate(0, 0);
            }

            100% {
                transform: rotateX(70deg) rotateZ(17deg) scale(1.1) translate(-220px, -200px);
            }
        }

        #stars-canvas {
            position: absolute;
            width: 100vw;
            height: 100vh;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            display: block;
        }

        .floating-glow {
            position: absolute;
            inset: 0;
            margin: auto;
            pointer-events: none;
            z-index: 2;
            filter: blur(38px);
            opacity: 0.23;
            border-radius: 2.1rem;
            width: 273px;
            height: 447px;
            background: radial-gradient(ellipse at 60% 30%, #9d81fa 60%, transparent 95%);
            animation: glow-pulse 5.2s ease-in-out infinite alternate;
            transition: opacity .3s;
        }

        @media (max-width: 600px) {
            .floating-glow {
                width: 94vw;
                height: 120px;
            }
        }

        @keyframes glow-pulse {
            from {
                opacity: .15;
                filter: blur(30px);
            }

            to {
                opacity: .32;
                filter: blur(56px);
            }
        }

        .login-box {
            position: relative;
            z-index: 3;
            max-width: 340px;
            min-width: 280px;
            background: rgba(35, 36, 58, 0.90);
            border-radius: 1.4rem;
            padding: 2.6rem 2.2rem 2.2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.8s ease-out, floaty 3.0s ease-in-out infinite alternate;
            backdrop-filter: blur(3.5px);
            opacity: 90%;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 0.9;
            }
        }

        @keyframes floaty {
            0% {
                transform: translateY(0px);
            }

            100% {
                transform: translateY(-10px);
            }
        }

        .logo {
            font-weight: 900;
            font-size: 2.3rem;
            letter-spacing: 0.09em;
            color: #8a5cff;
            margin-bottom: 2.2rem;
            text-shadow: 0 2px 14px #0003;
        }

        .field {
            width: 100%;
            margin-bottom: 1.15em;
        }

        .input {
            width: 100%;
            border-radius: .9em;
            border: 1.3px solid #242651;
            background: #212136;
            color: #e4e6ef;
            font-size: 1.07rem;
            padding: 0.82em 1em;
            box-shadow: 0 1px 10px #0003;
            outline: none;
            transition: background .2s, border .2s;
        }

        .input::placeholder {
            color: #989ab3;
            opacity: 1;
        }

        .input:focus {
            background: #26264b;
            border: 1.3px solid #7b60e6;
        }

        .submit {
            width: 100%;
            background: linear-gradient(90deg, #6a73f7 60%, #8a5cff 100%);
            color: #fff;
            border: none;
            border-radius: 1.3em;
            padding: .95em 0;
            font-size: 1.13rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 18px #6a73f733, 0 1px 4px #2d183833;
            margin-top: 1.2em;
            margin-bottom: .3em;
            position: relative;
            overflow: hidden;
            transition:
                background 0.22s cubic-bezier(.68,-0.55,.27,1.55),
                filter 0.19s,
                box-shadow 0.28s,
                transform 0.18s;
            animation: btn-glow-pulse 2.7s ease-in-out infinite alternate;
        }
        @keyframes btn-glow-pulse {
            0%, 100% { box-shadow: 0 2px 18px #8a5cff33, 0 1px 4px #2d183833; }
            60% { box-shadow: 0 4px 36px #8a5cff66, 0 1px 8px #6a73f788; }
        }
        .submit:hover,
        .submit:focus-visible {
            background: linear-gradient(90deg, #6a73f7 60%, #8a5cff 100%);
            filter: brightness(1.04);
            box-shadow: 0 7px 40px #8a5cff55, 0 2px 12px #2d183855;
            transform: translateY(-1.5px) scale(1.017);
        }

        .error {
            color: #f86d74;
            font-size: 1.03rem;
            min-height: 1.2em;
            margin-top: .8em;
            text-align: center;
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        .footer {
            font-size: .97rem;
            opacity: .38;
            text-align: center;
            margin-top: 1.7em;
            color: #e4e6ef;
        }
    </style>
</head>

<body>
    <div class="background">
        <div class="grid3d"></div>
        <canvas id="stars-canvas"></canvas>
        <div class="floating-glow"></div>
    </div>
    <form class="login-box" onsubmit="return window.doLogin(event)">
        <div class="logo">Waitgate</div>
        <div class="field">
            <input class="input" type="text" name="u" autocomplete="username" placeholder="User" required>
        </div>
        <div class="field">
            <input class="input" type="password" name="p" autocomplete="current-password" placeholder="Password"
                required>
        </div>
        <div class="field" id="field-tfa" style="display:none">
            <input class="input" type="text" name="tfa" id="input-tfa" maxlength="6" pattern="[0-9]*"
                placeholder="Code 2FA" autocomplete="one-time-code" inputmode="numeric">
        </div>
        <button class="submit">Log in</button>
        <div class="error" id="err"></div>
        <div class="footer">Waitgate &copy; 2025 • Prototype</div>
    </form>
    <script>
        // -- Fond animé (étoiles), inchangé --
        const canvas = document.getElementById('stars-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [], shootingStars = [];
        function resizeCanvas() {
            const ratio = window.devicePixelRatio > 1 ? 0.5 : 1;
            canvas.width = window.innerWidth * ratio;
            canvas.height = window.innerHeight * ratio;
            canvas.style.width = window.innerWidth + "px";
            canvas.style.height = window.innerHeight + "px";
            ctx.setTransform(ratio, 0, 0, ratio, 0, 0); // upscale le dessin
        }
        function rand(a, b) { return a + Math.random() * (b - a) }
        function createStars() {
            stars = [];
            for (let i = 0; i < 120; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    r: rand(0.32, 1.12),
                    o: rand(0.5, 0.93),
                    tw: rand(0, Math.PI * 2)
                })
            }
        }
        function createShootingStar() {
            if (shootingStars.length < 2 && Math.random() > 0.985) {
                const side = Math.random() > 0.5 ? 0 : canvas.width;
                shootingStars.push({
                    x: side,
                    y: rand(40, canvas.height * 0.7),
                    vx: side === 0 ? rand(5, 10) : -rand(5, 10),
                    vy: rand(-2, 2),
                    len: rand(110, 220),
                    alpha: 1.1
                });
            }
        }
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let s of stars) {
                ctx.save();
                ctx.globalAlpha = s.o * (0.5 + 0.5 * Math.sin(Date.now() / 1200 + s.tw));
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                ctx.fillStyle = "#e4e6ff";
                ctx.shadowColor = "#8a5cff";
                ctx.shadowBlur = 4;
                ctx.fill();
                ctx.restore();
            }
            for (let i = shootingStars.length - 1; i >= 0; i--) {
                let s = shootingStars[i];
                ctx.save();
                ctx.globalAlpha = Math.max(0, s.alpha);
                ctx.strokeStyle = "#8a5cffcc";
                ctx.shadowColor = "#8a5cff";
                ctx.shadowBlur = 8;
                ctx.beginPath();
                ctx.moveTo(s.x, s.y);
                ctx.lineTo(s.x - s.vx * s.len / 14, s.y - s.vy * s.len / 28);
                ctx.lineWidth = 2.2;
                ctx.stroke();
                ctx.restore();
                s.x += s.vx;
                s.y += s.vy;
                s.alpha -= 0.018;
                if (s.x < -300 || s.x > canvas.width + 300 || s.alpha <= 0)
                    shootingStars.splice(i, 1)
            }
            createShootingStar();
            requestAnimationFrame(draw);
        }
        window.addEventListener('resize', () => {
            resizeCanvas();
            createStars();
        });
        resizeCanvas();
        createStars();
        draw();
    </script>
    <script type="module">
        import { ChaCha20Poly1305 } from "https://cdn.skypack.dev/@stablelib/chacha20poly1305@2.0.1";
        function base64ToUint8(str) {
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            while (str.length % 4) str += '=';
            return new Uint8Array(atob(str).split('').map(c => c.charCodeAt(0)));
        }
        function uint8ToBase64(arr) {
            return btoa(String.fromCharCode(...arr));
        }
        async function encryptPassword(password, base64Key) {
            const key = base64ToUint8(base64Key);
            if (key.length !== 32) throw new Error("Clé ChaCha20 attendue 32 octets !");
            const nonce = window.crypto.getRandomValues(new Uint8Array(12));
            const msg = new TextEncoder().encode(password);
            const chacha = new ChaCha20Poly1305(key);
            const encrypted = chacha.seal(nonce, msg);
            const full = new Uint8Array(nonce.length + encrypted.length);
            full.set(nonce, 0);
            full.set(encrypted, nonce.length);
            return uint8ToBase64(full);
        }
        fetch('/api/tfa-setup')
        .then(r => r.json())
        .then(d => {
            if (d.enabled) {
                document.getElementById('field-tfa').style.display = "";
                document.getElementById('input-tfa').required = true;
            }
        });

        window.encryptPassword = encryptPassword;
        window.doLogin = async function doLogin(e) {
            e.preventDefault();
            const u = document.querySelector('[name="u"]').value;
            const p = document.querySelector('[name="p"]').value;
            const tfa = document.querySelector('[name="tfa"]')?.value || null;
            const key = window._loginKey;

            // Chiffrement
            const encryptedUser = await window.encryptPassword(u, key);
            const encryptedPass = await window.encryptPassword(p, key);
            let data = { u: encryptedUser, p: encryptedPass };

            if (tfa) {
                data.tfa = await window.encryptPassword(tfa, key);
            }

            fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(j => {
                if (j.ok) window.location = '/dashboard';
                else if (j.tfa)
                    document.getElementById('err').innerText = "Identifiants incorrects.";
                else
                    document.getElementById('err').innerText = "Identifiants incorrects.";
            });
            return false;
        }

    </script>
</body>

</html>
